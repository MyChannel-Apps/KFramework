var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}
if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}
if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}
function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}
function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}
function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}
function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}
var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}
var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}
var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var VERSION='1.0.3';var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°',};if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(this.hasOwnProperty(index)){continue;}
if(callback.apply(this[index],index)===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortBy});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){newObj[keys[k].index]=this[keys[k].index];delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,'startsWith',{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position;}});}
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,'endsWith',{value:function(searchString,position){var subjectString=this.toString();if(position===undefined||position>subjectString.length){position=subjectString.length;}
position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return lastIndex!==-1&&lastIndex===position;}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(callback.apply(this[index],index)===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){return this[RandomOperations.nextInt(this.length)];}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;};this.setFormat=function(format){_properties.format=format;};this.setText=function(text){_properties.timeUpText=text;};this.toString=function(){var string='°>{countdown}';var index=0;for(var name in _properties){string+=name+'='+_properties[name];if(index+1<Object.keys(_properties).length){string+='|';}
index++;}
string+='<°';return string;};}function KLink(text){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;function KLink(text){_text=text||'';}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;};this.enableHover=function(state){_hover=state;};this.toString=function(){var string='°>';if(_text instanceof KImage){string+=_text.toString(true);string+='|'+_text.toString(true)+'<>--<>';}else{if(_hover==false){string+='_h';}
string+=prepareLink(_text);}
if(_command_left!=undefined){string+='|'+_command_left;}
if(_command_right!=undefined){string+='|'+_command_right;}
string+='<°';return string;};KLink(text);};function KImage(image){var _path='';var _name='';var _extension='';var _properties={};function KImage(image){var split=image.split('.');_name=split[0];_extension=split[1];var first=_name.substring(0,1);if(first=='/'||first=='~'){_name=_name.substring(1);_path=KnuddelsServer.getFullImagePath('');}}
this.setContainerSize=function(width,height){_properties.w=width;_properties.h=height;};this.setSize=function(width,height){_properties.mw=width;_properties.mh=height;};this.setPosition=function(x,y){_properties.mx=x;_properties.my=y;};this.setLabel=function(text){_properties.label=text;};this.setLabelPosition=function(x,y){_properties.lmx=x;_properties.lmy=y;};this.setLabelColor=function(color){_properties.labelcolor=color;};this.enableLabelBorder=function(bool){_properties.labelborder=(bool==true?'1':'0');};this.setBorder=function(size){_properties.border=size;};this.setQuadcut=function(size){_properties.quadcut=size;};this.setShadow=function(position){_properties.shadow=position;};this.setMirror=function(state){_properties.mirror=(state==true?0x01:0x00);};this.setGreyscale=function(state){_properties.gray=(state==true?0x01:0x00);};this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+_path+_name;if(Object.keys(_properties).length>0){output+='..';for(var name in _properties){var value=_properties[name];if(value==0x00){continue;}
output+='.'+name+(value==0x01?'':'_'+value);}}
return output+'.'+_extension+(only_path==true?'':'<°');};KImage(image);}function KButton(text,command){var _text='';var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;};this.getText=function(){return _text;};this.setText=function(text){_text=text;};this.setIcon=function(icon){if(icon.indexOf('https://')==0||icon.indexOf('http://')==0){Logger.info("Can\t use http:// or https:// URL\'s on Buttons because the Path is implemented on the Client side!");}
_properties.icon=icon;};this.removeIcon=function(){delete _properties.icon;};this.setColor=function(color){_properties.color=color;};this.removeColor=function(){delete _properties.color;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;};this.removeHeight=function(){delete _properties.height;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;};this.removeWidth=function(){delete _properties.width;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);};this.removeSize=function(){this.removeWidth();this.removeHeight();};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;};this.getY=function(){return _properties.my;};this.setY=function(y){_properties.my=y;};this.setPosition=function(x,y){this.setX(x);this.setY(y);};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}};this.toString=function(){var string='°>{button}';if(_text.length>0){string+=_text+'||';}
if(_command.length>0){string+='call|'+_command;}
for(var name in _properties){string+='|'+name+'|'+_properties[name];}
string+='<°';return string;};KButton(text,command);}function KTable(){var _rows=[];this.add=function(element){_rows.push(element);};this.toString=function(){var output='°>{table';for(var index in _rows){var cel=_rows[index].getCells();output+='|'+cell.getSize();}
output+='}<°';for(var index in _rows){output+=_rows[index];}
output+='°>{endtable}<°';return output;};}
function KRow(){var _cells=[];function KRow(){_cells=arguments||[];}
this.getCells=function(){return _cells;};this.toString=function(){var output='°>{tr}<°';for(var index in _cells){output+=_cells[index];}
return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size;_content=content;}
this.toString=function(){return'°>{tc}<°'+_content;};KCell(size,content);}var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());var KConfig=(new function(){var _data=DB.load('_config');var _defaults={};var _puffer={};var _useChangesPuffer=false;this.setDefaults=function(defaults){_defaults=defaults;_data.compare(_defaults);};this.saveData=function(){DB.save('_config',_data);};this.resetData=function(){DB.save('_config',{});_data={};};this.applyChanges=function(){_useChangesPuffer=true;_puffer.each(function(newvalue,key){_data[key]=newvalue;});_puffer={};};this.get=function(key){if(key===undefined){Logger.error('No key submitted');return undefined;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return undefined;}
return _data[key];};this.set=function(key,value){if(key===undefined){Logger.error('No key submitted');return false;}
if(_data[key]===undefined){Logger.error('Key "'+key+'" not exists');return false;}
if(value===undefined){value=_defaults[key];}
if(!(error=this.check(key,value))){return error;}
if(_useChangesPuffer){_puffer[key]=value;}else{_data[key]=value;}};this.check=function(){return true;};}());var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}}}}}}};this.run=function(){var time=new Date();for(var index in _cronjobs){var job=_cronjobs[index];if(!job.isRunning()){continue;}
if(time.getTime()-job.getLastRun()>60000){if(Cron.match(job.getMinutes(),time.getMinutes())){if(Cron.match(job.getHours(),time.getHours())){if(Cron.match(job.getDate(),time.getDate())){if(Cron.match(job.getMonth(),time.getMonth())){if(Cron.match(job.getDay(),time.getDay())){job.run(time);}}}}}}}};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){for(var index=0;index<a.length;index++){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.onShutdown=function(){for(var index in _cronjobs){_cronjobs[index].onShutdown();}
if(_watcher!=undefined){clearInterval(_watcher);}};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_cycle=cycle;_callback=callback;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_crondb=DB.load('_cron_'+_name,{run:0,check:0});_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};Cron.add(instance);instance.start();}
this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.onShutdown=function(){this.stop();DB.save('_cron_'+_name,{run:_last_run.getTime(),check:_last_check.getTime()});};Cronjob(this,name,cycle,callback);}var Logger=(new function(){var _logger;function Logger(){_logger=KnuddelsServer.getDefaultLogger();};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';}
function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});return output;}
this.debug=function(message){_logger.debug(message+getStrackTrace());};this.info=function(message){_logger.info(message+getStrackTrace());};this.error=function(message){_logger.error(message+getStrackTrace());};this.fatal=function(message){_logger.fatal(message+getStrackTrace());};this.warn=function(message){_logger.warn(message+getStrackTrace());};Logger();}());var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot==true){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.exists('online')&&!filter.exists('inChannel')&&!filter.exists('away')&&!filter.exists('developer')&&!filter.exists('owner')&&!filter.exists('event')&&!filter.exists('cm')&&!filter.exists('status')&&!filter.exists('gender')&&!filter.exists('age')&&!filter.exists('nickname')&&!filter.exists('minutes')&&!filter.exists('readme')){return _users;}
_users.each(function(user,index){if(filter.online!=undefined&&filter.online==true&&user.isOnline()==true){users.push(user);}
if(filter.inChannel!=undefined&&filter.inChannel==true&&user.isOnlineInChannel()==true){users.push(user);}
if(filter.away!=undefined&&filter.away==true&&user.isAway()==true){users.push(user);}
if(filter.developer!=undefined&&filter.developer==true&&user.isAppDeveloper()==true){users.push(user);}
if(filter.owner!=undefined&&filter.owner==true&&user.isChannelOwner()==true){users.push(user);}
if(filter.event!=undefined&&filter.event==true&&user.isEventModerator()==true){users.push(user);}
if(filter.cm!=undefined&&filter.cm==true&&user.isChannelModerator()==true){users.push(user);}
if(filter.status!=undefined&&filter.status.exists(user.getUserStatus())){users.push(user);}
if(filter.gender!=undefined&&filter.gender.exists(user.getGender())){users.push(user);}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}});return users;};}());var KBank=(new function(){var _data=DB.load('_bank');this.create=function(uid){if(uid===undefined){return;}
if(_data[uid]===undefined){_data[uid]={knuddel:0.00,buyin:0.00,payout:0.00,};}};this.getKn=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid].knuddel;};this.getKonto=function(uid){if(uid===undefined){return;}
this.create(uid);return _data[uid];};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
_data[uid].knuddel=kn;};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);_data[uid].knuddel+=kn;};this.delKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
this.create(uid);if(kn<=0.00){return false;}
if(_data[uid].knuddel<kn){return false;}
_data[uid].knuddel-=kn;return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>_data[uid].knuddel){return false;}
this.create(uid);_data[uid].knuddel-=kn;_data[uid].payout+=kn;Bot.knuddel(KnuddelsServer.getUser(uid),kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<0){return false;}
this.create(uid);_data[uid].knuddel+=kn;_data[uid].buyin+=kn;};this.saveData=function(){this.cleanData();DB.save('_bank',_data);};this.resetData=function(){DB.save('_bank',{});_data={};};this.fixData=function(){_data.each(function(uid){_data[uid].knuddel=parseFloat(_data[uid].knuddel);_data[uid].buyin=parseFloat(_data[uid].buyin);_data[uid].payout=parseFloat(_data[uid].payout);});};this.cleanData=function(){_data.each(function(uid){if(_data[uid].knuddel!=0.00){return;}
if(_data[uid].buyin!=0.00){return;}
if(_data[uid].payout!=0.00){return;}
delete _data[uid];});};this.getUsers=function(){return Object.keys(_data);};this.getTransit=function(){transit=0.00;_data.each(function(uid){transit+=KBank.getKn(uid);});return transit;};this.fixData();}());var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof defaultValue){case'string':return selectedDB.getString(key,defaultValue);break;case'number':return selectedDB.getNumber(key,defaultValue);break;case'object':return selectedDB.getObject(key,defaultValue);break;case'undefined':return selectedDB.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
selectedDB=KnuddelsServer.getPersistence();if(user!=undefined){selectedDB=user.getPersistence();}
switch(typeof data){case'string':selectedDB.setString(key,data);break;case'number':selectedDB.setNumber(key,data);break;case'object':selectedDB.setObject(key,data);break;}
return true;};}());var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getNick=function(){return _user.getNick();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{nick.sendPostMessage(topic,message);}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{nick.sendPrivateMessage(message);}};this.exec=function(command){_user.sendToChannel(command);};}());function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);};this.newLine=function(){_buffer.push('°#°');_buffer.push('#');};this.setAlignment=function(alignment){_buffer.push(alignment);};this.addImage=function(file){_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');};this.toString=function(){var string='';for(var index in _buffer){var component=_buffer[index];if(component instanceof String){string+=component;}else{string+=component.toString();}}
if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};var Users=(new function(){this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){nickname=KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isEventModerator=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.sendPostMessage=function(topic,message){Logger.error('Can\t send message to a virtual User-Object!');};this.sendPrivateMessage=function(message){Logger.error('Can\t send message to a virtual User-Object!');};}());}
return nickname;};}());