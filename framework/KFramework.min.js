/**
	The MIT License (MIT)
	Copyright (c) 2015 MyChannel-Apps.de
	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:
	The above copyright notice and this permission notice shall be included in
	all copies or substantial portions of the Software.
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
	THE SOFTWARE.
	
	@author		Adrian Preuß <Bizarrus>, Christoph Kühl <djchrisnet>
	@docs		http://www.mychannel-apps.de/documentation/
	@version	1.0.6
	@build		Mon, 23 Mar 2015 03:14:01 +0100
*/


function isTypeOf(object,toCheck){var type=object.javaClassName
if(type===undefined){type=typeof(object);}
return(toCheck===undefined)?type:(toCheck==type);}
function AND(b1,b2){return((b1)&&(b2));}
function OR(b1,b2){return((b1)||(b2));}
function NOT(b1){return!(b1);}
function XOR(b1,b2){return((b1)==true&&(b2)==false)||((b1)==false&&(b2)==true);}
function clone(src){function mixin(dest,source,copyFunc){var name,s,i,empty={};for(name in source){s=source[name];if(!(name in dest)||(dest[name]!==s&&(!(name in empty)||empty[name]!==s))){dest[name]=copyFunc?copyFunc(s):s;}}
return dest;}
if(!src||typeof src!="object"||Object.prototype.toString.call(src)==="[object Function]"){return src;}
if(src instanceof Date){return new Date(src.getTime());}
if(src instanceof RegExp){return new RegExp(src);}
if(src instanceof Array){return[].concat(src);}
if(src instanceof StringBuffer){return new StringBuffer(src.toString());}
if(src instanceof KCode){return new KCode().append(src.toString());}
if(src instanceof KButton){return new KButton(src.getText(),src.getCommand()).setId(src.getId()).setProperties(src.getProperties());}
return mixin(src.constructor?new src.constructor():{},src,clone);}
if(!Number.prototype.fix){Object.defineProperty(Number.prototype,'fix',{enumerable:false,configurable:false,writable:false,value:function(count){return parseFloat(this.toFixed(parseInt(count)||2));}});}
if(!Number.prototype.format){Object.defineProperty(Number.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(n,x){return this.toFixed(Math.max(0,~~n)).replace(new RegExp('\\d(?=(\\d{'+(x||3)+'})+'+(n>0?'\\.':'$')+')','g'),'$&,');}});}
if(!String.prototype.urlencode){Object.defineProperty(String.prototype,'urlencode',{enumerable:false,configurable:false,writable:false,value:function(){return encodeURIComponent(this);}});}
if(!String.prototype.format){Object.defineProperty(String.prototype,'format',{enumerable:false,configurable:false,writable:false,value:function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return(typeof(args[number])!='undefined')?args[number]:match;});}});}
if(!String.prototype.formater){Object.defineProperty(String.prototype,'formater',{enumerable:false,configurable:false,writable:false,value:function(data){return this.replace(/\$[a-zA-Z]+/gi,function(match){return(typeof(data[match.substring(1)])!='undefined')?data[match.substring(1)]:match;});}});}
if(!String.prototype.contains){Object.defineProperty(String.prototype,'contains',{enumerable:false,configurable:false,writable:false,value:function(args){if(typeof(args)=='string'){args=[args];}
for(var x in args){if(this.indexOf(args[x])>-1){return true;}}
return false;}});}
if(!Array.prototype.each){Object.defineProperty(Array.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index=0;index<this.length;index++){if(isTypeOf(this[index],'object')){if(callback.call(this,this[index],index)===false){break;}}else if(callback.apply(this,[this[index],index])===false){break;}}}});}
if(!Array.prototype.random){Object.defineProperty(Array.prototype,'random',{enumerable:false,configurable:false,writable:false,value:function(){var random=RandomOperations.nextInt(this.length);if(this.length<=0||random>=this.length){return undefined;}
return this[random];}});}
if(!Array.prototype.shuffle){Object.defineProperty(Array.prototype,'shuffle',{enumerable:false,configurable:false,writable:false,value:function(){this.sort(function(a,b){return(0.5-Math.random());});}});}
if(!Array.prototype.exists){Object.defineProperty(Array.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this.indexOf(value)>-1);}});}
if(!Array.prototype.size){Object.defineProperty(Array.prototype,'size',{enumerable:false,configurable:false,writable:false,value:function(){return this.length;}});}
if(!Array.prototype.first){Object.defineProperty(Array.prototype,'first',{enumerable:false,configurable:false,writable:false,value:function(){return this[0];}});}
if(!Array.prototype.last){Object.defineProperty(Array.prototype,'last',{enumerable:false,configurable:false,writable:false,value:function(){return this[this.length-1];}});}
if(!Array.prototype.clear){Object.defineProperty(Array.prototype,'clear',{enumerable:false,configurable:false,writable:false,value:function(){this.length=0;return this;}});}
if(!Object.prototype.each){Object.defineProperty(Object.prototype,'each',{enumerable:false,configurable:false,writable:false,value:function(callback){for(var index in this){if(!this.hasOwnProperty(index)){continue;}
if(typeof(this[index])=='object'){if(callback.call(this,this[index],index)===false){break;}}else if(callback.apply(this,[this[index],index])===false){break;}}}});}
if(!Object.prototype.sort){Object.defineProperty(Object.prototype,'sort',{enumerable:false,configurable:false,writable:false,value:function(byKey,order){if(byKey===undefined){byKey=='index';}
if(order===undefined){order=='ASC';}
var keys=[];for(var index in this){var sortby=0;if(byKey=='index'){sortby=index;}else if(byKey=='value'){sortby=this[index];}else if(this[index].hasOwnProperty(byKey)){sortby=this[index][byKey];}
keys.push({index:index,value:this[index],sortby:sortby});}
if(order=='ASC'){keys.sort(function(a,b){return a.sortby-b.sortby;});}else{keys.sort(function(a,b){return b.sortby-a.sortby;});}
var newObj={};for(var k in keys){if(keys[k]!=undefined){newObj[keys[k].index]=this[keys[k].index];}
delete this[keys[k].index];}
for(var key in newObj){this[key]=newObj[key];}
return newObj;}});}
if(!Object.prototype.exists){Object.defineProperty(Object.prototype,'exists',{enumerable:false,configurable:false,writable:false,value:function(value){return(this[value]!=undefined);}});}
if(!Object.prototype.compare){Object.defineProperty(Object.prototype,'compare',{enumerable:false,configurable:false,writable:false,value:function(defaultObj){for(var property in defaultObj){if(this[property]&&(typeof(this[property])=='object')&&(this[property].toString()=='[object Object]')&&defaultObj[property]){this[property].compare(defaultObj[property]);}else if(typeof this[property]=='undefined'){this[property]=defaultObj[property];}}
return this;}});}
if(!Object.prototype.size){Object.defineProperty(Object.prototype,'size',{enumerable:false,configurable:false,writable:false,value:function(){return Object.keys(this).length;}});}
if(!User.prototype.getID){Object.defineProperty(User.prototype,'getID',{enumerable:false,configurable:false,writable:false,value:function(){return this.getUserId();}});}
if(!User.prototype.private){Object.defineProperty(User.prototype,'private',{enumerable:false,configurable:false,writable:false,value:function(msg){this.sendPrivateMessage(msg);}});}
if(!User.prototype.post){Object.defineProperty(User.prototype,'post',{enumerable:false,configurable:false,writable:false,value:function(topic,text){this.sendPostMessage(topic,text);}});}
if(!User.prototype.getProfilePicture){Object.defineProperty(User.prototype,'getProfilePicture',{enumerable:false,configurable:false,writable:false,value:function(){return(this.hasProfilePhoto())?'http://chat.knuddels.de/pics/fotos/knuddels.de?n='+this.getNick().urlencode():'';}});}
if(!User.prototype.getKonto){Object.defineProperty(User.prototype,'getKonto',{enumerable:false,configurable:false,writable:false,value:function(){return KBank.getKonto(this.getUserId());}});}
if(!User.prototype.getKn){Object.defineProperty(User.prototype,'getKn',{enumerable:false,configurable:false,writable:false,value:function(){return KBank.getKn(this.getUserId());}});}
if(!User.prototype.addKn){Object.defineProperty(User.prototype,'addKn',{enumerable:false,configurable:false,writable:false,value:function(kn){return KBank.addKn(this.getUserId(),kn);}});}
if(!User.prototype.subKn){Object.defineProperty(User.prototype,'subKn',{enumerable:false,configurable:false,writable:false,value:function(kn){return KBank.subKn(this.getUserId(),kn);}});}
if(!User.prototype.knuddel){Object.defineProperty(User.prototype,'knuddel',{enumerable:false,configurable:false,writable:false,value:function(amount,message){if(amount===undefined){return false;}
if(message===undefined){Bot.knuddel(this,amount);}else{Bot.knuddel(this,amount,message);}
return true;}});}
if(!User.prototype.getKnuddels){Object.defineProperty(User.prototype,'getKnuddels',{enumerable:false,configurable:false,writable:false,value:function(){return this.getKnuddelAmount().asNumber();}});}
if(!User.prototype.isVirtual){Object.defineProperty(User.prototype,'isVirtual',{enumerable:false,configurable:false,writable:false,value:function(){return false;}});}
if(!DiceEvent.prototype.getTotal){Object.defineProperty(DiceEvent.prototype,'getTotal',{enumerable:false,configurable:false,writable:false,value:function(){return this.getDiceResult().totalSum();}});}
if(!DiceEvent.prototype.checkUser){Object.defineProperty(DiceEvent.prototype,'checkUser',{enumerable:false,configurable:false,writable:false,value:function(user){return this.getUser().equals(user);}});}
if(!DiceEvent.prototype.checkConf){Object.defineProperty(DiceEvent.prototype,'checkConf',{enumerable:false,configurable:false,writable:false,value:function(conf){return this.getDiceResult().getDiceConfiguration().equals(conf);}});}
function StringBuffer(startText){var _data=startText||'';this.append=function(data){_data+=data;return this;};this.toString=function(){return _data;};};
var Hash={decodeForm:function(string){var chars=string.split('');var output=[];var a=97;var b=4;for(var index=0,char_index=0;index<chars.length/2;index++,char_index+=2){output.push((chars[char_index].charCodeAt(0)-a<<b|chars[char_index+1].charCodeAt(0)-a)^index&255);}
for(var index=0;index<output.length;index++){output[index]=output.fromCharCode(output[index]);}
return output.join('');},toString:function(){return'[KFramework Hash]';}};
var Hooks=(new function(){var _hooks={};var _debug=false;this.addFilter=function(name,callback,priority){this.add(name,callback,priority,true);return this;};this.addAction=function(name,callback,priority){this.add(name,callback,priority);return this;};this.add=function(name,callback,priority,is_filter){priority=(priority==undefined?10:priority);is_filter=(is_filter==undefined?false:is_filter);if(_hooks[priority]==undefined){_hooks[priority]=[];}
if(_debug){if(Logger==undefined){KnuddelsServer.getDefaultLogger().info('[Hooks] Adding "'+name+'" with Priority of '+priority);}else{Logger.info('[Hooks] Adding "'+name+'" with Priority of '+priority);}}
_hooks[priority].push({name:name,callback:callback,is_filter:is_filter});return this;};this.remove=function(name,priority){priority=(priority==undefined?10:priority);if(_debug){if(Logger==undefined){KnuddelsServer.getDefaultLogger().info('[Hooks] Removing "'+name+'" with Priority of '+priority);}else{Logger.info('[Hooks] Removing "'+name+'" with Priority of '+priority);}}
if(!Object.prototype.each){for(var index in _hooks[priority]){var hook=_hooks[priority][index];if(hook.name==name){delete _hooks[priority][index];}}}else{_hooks[priority].each(function(hook,index){if(hook.name==name){delete _hooks[priority][index];}});}
return this;};this.applyFilter=function(name){var args=[];var args_length=arguments.size();for(var index=0;index<args_length;++index){var argument=arguments[index];if(argument==undefined||argument==null){continue;}
args.push(argument);}
args.splice(1,0,true);return this.do.apply(this,args);};this.do=function(name,is_filter){if(_debug){if(Logger==undefined){KnuddelsServer.getDefaultLogger().info('[Hooks] '+JSON.stringify(arguments));}else{Logger.info('[Hooks] '+JSON.stringify(arguments));}}
var is_filter_set=(is_filter==undefined||typeof(is_filter)!='boolean');var args=[];var args_length=arguments.size();var output=undefined;for(var index=0;index<args_length;++index){var argument=arguments[index];if(argument==undefined||argument==null){continue;}
args.push(argument);}
args.shift();if(!is_filter_set){args.shift();}
output=args[0];if(_debug){if(Logger==undefined){KnuddelsServer.getDefaultLogger().info('[Hooks] Execute "'+name+'" with params: '+JSON.stringify(args));}else{Logger.info('[Hooks] Execute "'+name+'" with params: '+JSON.stringify(args));}}
if(!Array.prototype.sort){if(Logger==undefined){KnuddelsServer.getDefaultLogger().warn('Hooks won\'t sort by Priority because Array.sort(); is not available. Please import framework/tools/Array.js!');}else{Logger.warn('Hooks won\'t sort by Priority because Array.sort(); is not available. Please import framework/tools/Array.js!');}}else{_hooks.sort('index','ASC');}
if(!Object.prototype.each){for(var priority in _hooks){var hooks=_hooks[priority];if(_debug){if(Logger==undefined){KnuddelsServer.getDefaultLogger().info('[Hooks] Each: PRIORITY '+priority);}else{Logger.info('[Hooks] Each: PRIORITY '+priority);}}
for(var index in hooks){var hook=hooks[index];if(hook.name==name){if(typeof(output)!='array'){output=[output];}
output=hook.callback.apply(this,((is_filter_set?false:is_filter)?output:args));}}}}else{_hooks.each(function(hooks,priority){if(_debug){if(Logger==undefined){KnuddelsServer.getDefaultLogger().info('[Hooks] Each: PRIORITY '+priority);}else{Logger.info('[Hooks] Each: PRIORITY '+priority);}}
hooks.each(function(hook){if(hook.name==name){if(typeof(output)!='array'){output=[output];}
output=hook.callback.apply(this,((is_filter_set?false:is_filter)?output:args));}});});}
return output;};this.toString=function(){return'[KFramework Hooks]';};}());
var DB=(new function(){this.getUser=function(user){Logger.info('DB.getUser(user) is DEPRECATED');return user.getPersistence();};this.getChannel=function(){Logger.info('DB.getChannel() is DEPRECATED');return KnuddelsServer.getPersistence();};this.load=function(key,defaultValue,user){if(key===undefined){Logger.error('No key submitted');return false;}
var _db=KnuddelsServer.getPersistence();if(user!=undefined){_db=user.getPersistence();}
switch(typeof defaultValue){case'string':return _db.getString(key,defaultValue);break;case'number':return _db.getNumber(key,defaultValue);break;case'object':return _db.getObject(key,defaultValue);break;case'undefined':return _db.getObject(key,{});break;}
return false;};this.save=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
var _db=KnuddelsServer.getPersistence();if(user!=undefined){_db=user.getPersistence();}
switch(typeof data){case'string':_db.setString(key,data);break;case'number':_db.setNumber(key,data);break;case'object':_db.setObject(key,data);break;}
return true;};this.check=function(key,data,user){if(key===undefined){Logger.error('No key submitted');return false;}
if(data===undefined){Logger.error('No Data submitted');return false;}
var _db=KnuddelsServer.getPersistence();if(user!=undefined){_db=user.getPersistence();}
switch(typeof data){case'string':return _db.hasString(key);break;case'number':return _db.hasNumber(key);break;case'object':return _db.hasObject(key);break;}
return false;};this.delete=function(key,user){if(key===undefined){Logger.error('No key submitted');return false;}
var _db=KnuddelsServer.getPersistence();if(user!=undefined){_db=user.getPersistence();}
if(_db.hasString(key)){_db.deleteString(key);}
if(_db.hasNumber(key)){_db.deleteNumber(key);}
if(_db.hasObject(key)){_db.deleteObject(key);}};this.sum=function(key){if(key===undefined){Logger.error('No key submitted');return false;}
return UserPersistenceNumbers.getSum(key);};this.count=function(key,from,to){if(key===undefined){Logger.error('No key submitted');return false;}
var options={};if(from!=undefined&&typeof(from)=='number'){options['minimumValue']=from;}
if(to!=undefined&&typeof(to)=='number'){options['maximumValue']=to;}
return UserPersistenceNumbers.getCount(key,options);};this.sorted=function(key,sortBy,count,page){if(key===undefined){Logger.error('No key submitted');return false;}
var options={};if(sortBy!=undefined){options['ascending']=(sortBy=='ASC')?true:false;}
if(count!=undefined&&typeof(count)=='number'){options['count']=count;}
if(page!=undefined&&typeof(page)=='number'){options['page']=page;}
return UserPersistenceNumbers.getSortedEntries(key,options);};this.users=function(key,callback,sortBy,from,to){if(key===undefined){Logger.error('No key submitted');return false;}
if(callback===undefined){Logger.error('No callback submitted');return false;}
var options={};if(sortBy!=undefined){options['ascending']=(sortBy=='ASC')?true:false;}
if(from!=undefined&&typeof(from)=='number'){options['minimumValue']=from;}
if(to!=undefined&&typeof(to)=='number'){options['maximumValue']=to;}
return UserPersistenceNumbers.each(key,callback,options);};this.toString=function(){return'[KFramework Database]';};}());
var Logger=(new function(){var _logger;var _watcher;function Logger(){_logger=KnuddelsServer.getDefaultLogger();_watcher={};};this.addLogUser=function(uid,types){Logger.info('Logger.addLogUser(uid, types) is DEPRECATED');_watcher[uid]=types||'E_ALL';};this.delLogUser=function(uid){Logger.info('Logger.delLogUser(uid) is DEPRECATED');if(_watcher[uid]!=undefined){delete _watcher[uid];}};function getStrackTrace(){try{null.toString();}catch(e){return prettyStackTrace(e.stack);}
return'';};function prettyStackTrace(stack){var lines=stack.replace(/\t/g,'     ').replace(/\(anonymous\)/g,'').replace(/at (.*)@(.*): /g,'at ').split('\n');var output='';if(!Object.prototype.each){for(var index in lines){if(index<=1){return;}
output+='\n'+lines[index];}}else{lines.each(function(line,index){if(index<=1){return;}
output+='\n'+line;});}
return output;};function sendLog(prefix,message){if(_watcher.size()>0){Logger.info('Logger.sendLog(prefix, message) is DEPRECATED - Don\'t use Logger.addLogUser(uid, types) or Logger.delLogUser(uid)!');}
_watcher.each(function(value,uid){if(value.contains(prefix)||value=='E_ALL'){Users.get(uid).sendPrivateMessage(prefix+': '+message);}});};this.debug=function(message){_logger.debug(message+getStrackTrace());sendLog('DEBUG',message);};this.info=function(message){_logger.info(message+getStrackTrace());sendLog('INFO',message);};this.error=function(message){_logger.error(message+getStrackTrace());sendLog('ERROR',message);};this.fatal=function(message){_logger.fatal(message+getStrackTrace());sendLog('FATAL',message);};this.warn=function(message){_logger.warn(message+getStrackTrace());sendLog('WARN',message);};this.toString=function(){return'[KFramework Logger]';};Logger();}());
var Cron=(new function(){var _cronjobs=[];var _watcher;var _offlineCheck=false;this.init=function(){if(_watcher!=undefined){clearInterval(_watcher);}
_watcher=setInterval(this.run,500);};this.enableOfflineRunCheck=function(){_offlineCheck=true;};this.checkOfflineRun=function(job){if(job.getLastCheck()==0){return;}
while(new Date().getTime()>=job.getLastCheck()){var time=new Date(job.getLastCheck()+500);job.setLastCheck(time);if((time.getTime()-job.getLastRun()>60000)&&Cron.match(job.getMinutes(),time.getMinutes())&&Cron.match(job.getHours(),time.getHours())&&Cron.match(job.getDate(),time.getDate())&&Cron.match(job.getMonth(),time.getMonth())&&Cron.match(job.getDay(),time.getDay())){job.run(time);return;}}};this.run=function(){var time=new Date();_cronjobs.each(function(job){if(!job.isRunning()){return;}
if((time.getTime()-job.getLastRun()>60000)&&Cron.match(job.getMinutes(),time.getMinutes())&&Cron.match(job.getHours(),time.getHours())&&Cron.match(job.getDate(),time.getDate())&&Cron.match(job.getMonth(),time.getMonth())&&Cron.match(job.getDay(),time.getDay())){job.run(time);}});};this.add=function(cronjob){_cronjobs.push(cronjob);if(_offlineCheck){this.checkOfflineRun(cronjob);}};this.match=function(a,b){var index=0;var length=a.length;for(;index<length;++index){var c=a[index];if(c[0]===-1||(b>=c[0]&&b<=c[1])){var b0=b-c[0];if(c[2]===-1||b===0||b%c[2]===0){return true;}}}
return false;};this.parse=function(entry){return entry.split(',').map(function(index){var z=index.split('/');var x=z[0].split('-');if(x[0]=='*'){x[0]=-1;}
if(x.length==1){x.push(x[0]);}
x[2]=z.length===1?-1:z[1];x[0]=parseInt(x[0]);x[1]=parseInt(x[1]);x[2]=parseInt(x[2]);return x;});};this.saveData=function(){_cronjobs.each(function(cron){cron.save();});};this.onShutdown=function(){_cronjobs.each(function(cron){cron.onShutdown();});if(_watcher!=undefined){clearInterval(_watcher);}};this.toString=function(){return'[KFramework Cron]';};this.init();}());function Cronjob(name,cycle,callback){var _name='';var _cycle='* * * * *';var _cycle_data=[];var _is_running=false;var _callback=function(time){};var _last_run=undefined;var _last_check=undefined;var _time_data={minute:'*',hour:'*',date:'*',month:'*',day:'*'};function Cronjob(instance,name,cycle,callback){_name=name;_callback=callback;instance.changeCycle(cycle);if(DB==undefined){_crondb=KnuddelsServer.getPersistence().getObject('_cron_'+_name,{run:0,check:0});}else{_crondb=DB.load('_cron_'+_name,{run:0,check:0});}
_last_run=new Date(parseInt(_crondb.run));_last_check=new Date(parseInt(_crondb.check));Cron.add(instance);instance.start();}
this.changeCycle=function(cycle){_cycle=cycle;_cycle_data=_cycle.match(/^([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s+([0-9,\-\/]+|\*{1}|\*{1}\/[0-9]+)\s*$/);_time_data={minute:Cron.parse(_cycle_data[1]),hour:Cron.parse(_cycle_data[2]),date:Cron.parse(_cycle_data[3]),month:Cron.parse(_cycle_data[4]),day:Cron.parse(_cycle_data[5])};};this.getLastRun=function(){return _last_run.getTime();};this.getName=function(){return _name;};this.getLastCheck=function(){return _last_check.getTime();};this.setLastCheck=function(time){_last_check=time;};this.isRunning=function(){return _is_running;};this.start=function(){_is_running=true;};this.stop=function(){_is_running=false;};this.run=function(time){_last_check=time;_last_run=time;_callback(time);};this.getMinutes=function(){return _time_data.minute;};this.getHours=function(){return _time_data.hour;};this.getDate=function(){return _time_data.date;};this.getMonth=function(){return _time_data.month;};this.getDay=function(){return _time_data.day;};this.save=function(){if(DB==undefined){KnuddelsServer.getPersistence().setObject('_cron_'+_name,{run:this.getLastRun(),check:this.getLastCheck()});return;}
DB.save('_cron_'+_name,{run:this.getLastRun(),check:this.getLastCheck()});};this.onShutdown=function(){this.stop();this.save();};this.toString=function(){return'[KFramework Cronjob]';};Cronjob(this,name,cycle,callback);}
var Bot=(new function(){var _user=KnuddelsServer.getDefaultBotUser();this.getAge=function(){return _user.getAge();};this.getGender=function(){return _user.getGender();};this.getKnuddelAmount=function(){return _user.getKnuddelAmount();};this.getNick=function(){return _user.getNick();};this.getOnlineMinutes=function(){return _user.getOnlineMinutes();};this.getProfileLink=function(displayText){return _user.getProfileLink(displayText==undefined?this.getNick():displayText);};this.getProfilePicture=function(){return'http://chat.knuddels.de/pics/fotos/knuddels.de?n='+_user.getNick().urlencode();};this.getReadme=function(){return _user.getReadme();};this.getRegDate=function(){return _user.getRegDate();};this.getUserId=function(){return _user.getUserId();};this.getUserStatus=function(){return _user.getUserStatus();};this.getUserType=function(){return _user.getUserType();};this.isAppDeveloper=function(){return _user.isAppDeveloper();};this.isAppManager=function(){return _user.isAppManager();};this.isAway=function(){return _user.isAway();};this.isChannelModerator=function(){return _user.isChannelModerator();};this.isChannelOwner=function(){return _user.isChannelOwner();};this.isColorMuted=function(){return _user.isColorMuted();};this.isEventModerator=function(){return _user.isEventModerator();};this.isLocked=function(){return _user.isLocked();};this.isMuted=function(){return _user.isMuted();};this.isOnline=function(){return _user.isOnline();};this.isOnlineInChannel=function(){return _user.isOnlineInChannel();};this.join=function(){_user.joinChannel();};this.leave=function(){_user.leaveChannel();};this.knuddel=function(user,amount,message){if(!isTypeOf(amount,'KnuddelAmount')){amount=new KnuddelAmount(amount);}
if(message===undefined){_user.transferKnuddel(user,amount);}else{_user.transferKnuddel(user,amount,message);}};this.getKnuddels=function(){return _user.getKnuddelAmount().asNumber();};this.exception=function(exception){_user.sendPublicMessage('°RR°_Exception:_°r°#'+(exception.message==undefined?exception:exception.message));};this.publicMessage=function(message){Logger.info('Bot.publicMessage(message) is DEPRECATED');this.public(message);}
this.postMessage=function(user,message,topic){Logger.info('Bot.postMessage(user, message, topic) is DEPRECATED');this.post(user,message,topic);}
this.privateMessage=function(user,message){Logger.info('Bot.privateMessage(user, message) is DEPRECATED');this.private(user,message);}
this.public=function(message){if(message instanceof KCode){message=message.toString();}
_user.sendPublicMessage(message);};this.post=function(nick,message,topic){if(message instanceof KCode){message=message.toString();}
if(topic==undefined){topic='';}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPostMessage(topic,message);});}else{if(isTypeOf(nick,'User')){nick.sendPostMessage(topic,message);}else if(isTypeOf(nick,'object')||isTypeOf(nick,'array')){nick.each(function(n){Bot.post(n,message,topic);});}else{Users.get(nick).sendPostMessage(topic,message);}}};this.private=function(nick,message){if(message instanceof KCode){message=message.toString();}
if(nick==undefined){Channel.getUsers().each(function(user){user.sendPrivateMessage(message);});}else{if(isTypeOf(nick,'User')){nick.sendPrivateMessage(message);}else if(isTypeOf(nick,'object')||isTypeOf(nick,'array')){nick.each(function(n){Bot.private(n,message);});}else{var nick=Users.get(nick);if(nick!=undefined){nick.sendPrivateMessage(message);}}}};this.exec=function(command){_user.sendToChannel(command);};this.toString=function(){return'[KFramework Bot]';};}());
var load=['KButton','KTooltip','KLink','KCountdown','KFont','KImage','KColor','KTable','KGroup'];load.each(function(name){});var Alignment={LEFT:'°>LEFT<°',MIDDLE:'°>CENTER<°',CENTER:'°>CENTER<°',RIGHT:'°>RIGHT<°',JUSTIFY:'°>JUSTIFY<°'};function KCode(){var _buffer=[];var _debug=false;var _minify=true;this.append=function(component){_buffer.push(component);return this;};this.newLine=function(dotted){_buffer.push('°#');if(dotted==undefined?false:dotted){_buffer.push('!');}
_buffer.push('°');_buffer.push('#');return this;};this.newHr=function(){_buffer.push('°-°');return this;};this.addDots=function(){_buffer.push('.........');return this;};this.setAlignment=function(alignment){_buffer.push(alignment);return this;};this.addImage=function(file){Logger.info('KCode.addImage(file) is DEPRECATED');_buffer.push('°>'+KnuddelsServer.getFullImagePath(file)+'<°');return this;};this.disableOptimization=function(state){_minify=state;return this;};this.toString=function(){var string='';_buffer.each(function(component){if(typeof(component)=='string'||typeof(component)=='number'){string+=component;}else if(component!=undefined&&component!=null){string+=component.toString();}});if(_debug){string=string.replace(/°/g,'\\°');}
if(_minify){string=string.replace(/°°/g,'');}
return string;};};
var KBank=(new function(){this.getKn=function(uid){if(uid===undefined){return;}
var _db=Users.get(parseInt(uid)).getPersistence();return parseFloat(_db.getNumber('KBank_knuddel',0.00).toFixed(2));};this.getKonto=function(uid){if(uid===undefined){return;}
var _db=Users.get(parseInt(uid)).getPersistence();return{knuddel:parseFloat(_db.getNumber('KBank_knuddel',0.00).toFixed(2)),buyin:parseFloat(_db.getNumber('KBank_buyin',0.00).toFixed(2)),payout:parseFloat(_db.getNumber('KBank_payout',0.00).toFixed(2))};};this.setKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<=0.00){return false;}
var _db=Users.get(parseInt(uid)).getPersistence();_db.setNumber('KBank_knuddel',kn);};this.addKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<=0.00){return false;}
var _db=Users.get(parseInt(uid)).getPersistence();_db.addNumber('KBank_knuddel',kn);return true;};this.delKn=function(uid,kn){Logger.info('KBank.delKn(uid, kn) is DEPRECATED, use KBank.subKn(uid, kn)');return this.subKn(uid,kn);};this.subKn=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<=0.00){return false;}
if(kn>this.getKn(uid)){return false;}
var _db=Users.get(parseInt(uid)).getPersistence();_db.addNumber('KBank_knuddel',-kn);return true;};this.payout=function(uid,kn,reason){if(uid===undefined){return false;}
if(kn===undefined){return false;}
if(kn<0){return false;}
if(kn>this.getKn(uid)){return false;}
if(kn>Bot.getKnuddels()){return false;}
if(kn>=1000000){return false;}
var _user=Users.get(parseInt(uid));var _db=_user.getPersistence();_db.addNumber('KBank_knuddel',-kn);_db.addNumber('KBank_payout',kn);Bot.knuddel(_user,kn,reason);return true;};this.payin=function(uid,kn){if(uid===undefined){return;}
if(kn===undefined){return;}
if(kn<=0.00){return false;}
var _db=Users.get(parseInt(uid)).getPersistence();_db.addNumber('KBank_knuddel',kn);_db.addNumber('KBank_buyin',kn);return true;};this.getUsers=function(callback){if(typeof callback!=='function'){Logger.info('KBank.getUsers() is DEPRECATED, use it like this KBank.getUsers(function(userIds, total){ });');return false;}
var _users=[];UserPersistenceNumbers.each('KBank_knuddel',function(user,value,index,total,key){_users.push(user.getUserId());},{ascending:false,onStart:function(totalCount){_users=[];},onEnd:function(totalCount){callback.call(this,_users,totalCount);}});};this.getStats=function(){return{users:DB.count('KBank_knuddel'),knusers:DB.count('KBank_knuddel',0.01),knuddel:parseFloat(DB.sum('KBank_knuddel')),buyin:parseFloat(DB.sum('KBank_buyin')),payout:parseFloat(DB.sum('KBank_payout'))};};this.getTransit=function(){return parseFloat(DB.sum('KBank_knuddel'));};this.toString=function(){return'[KFramework KBank]';};this.dataMigration=function(){if(DB.check('_bank',{})==false){return true;}
var migrate=DB.load('_bank',{});if(!migrate.size()){DB.delete('_bank');Logger.info('KBank fully migrated! You can now delete all "KBank.saveData()" and "KBank.loadData()" calls from your AppCode');return false;};var _db=null;var migrated=[];var start=new Date().getTime();migrate.each(function(konto,uid){_db=Users.get(parseInt(uid)).getPersistence();_db.setNumber('KBank_knuddel',parseFloat(konto.knuddel.toFixed(2)));_db.setNumber('KBank_buyin',parseFloat(konto.buyin.toFixed(2)));_db.setNumber('KBank_payout',parseFloat(konto.payout.toFixed(2)));migrated.push(uid);if((new Date().getTime()-start)>9000){return false;}});if(migrate.size()==migrated.size()){DB.delete('_bank');Logger.info('KBank fully migrated! You can now delete all "KBank.loadData()" and "KBank.saveData()" calls from your AppCode');}else{migrated.each(function(uid){delete migrate[uid];});DB.save('_bank',migrate);Logger.info('KBank can´t migrate all data at once ('+migrated.size()+' of '+migrate.size()+' finish). Please restart this App to migrate the last '+(migrate.size()-migrated.size())+' KBank Entrys');}
return false;};this.getData=function(){Logger.info('KBank.getData() is DEPRECATED, you dont need this all any more!');};this.loadData=function(){Logger.info('KBank.loadData() is DEPRECATED, you dont need this all any more!');};this.saveData=function(){Logger.info('KBank.saveData() is DEPRECATED, you dont need this all any more!');};this.resetData=function(){Logger.info('KBank.resetData() is DEPRECATED, you dont need this all any more!');};this.fixData=function(){Logger.info('KBank.fixData() is DEPRECATED, you dont need this all any more!');};this.cleanData=function(){Logger.info('KBank.cleanData() is DEPRECATED, you dont need this all any more!');};}());
var Background={SCALED:0,SCALE_FILLED_MODE1:6,SCALE_FILLED_MODE2:10,SCALE_FILLED_MODE3:54,SCALE_COMPLETE_CENTERED:7,SCALE_HEIGHT_RIGHT:61,SCALE_HEIGHT_TOP:40,SCALE_HEIGHT_BOTTOM:56,TILED:17,TILED_ZOOM_X2:33,TILED_ZOOM_X3:59,TILED_OFFSET_HORIZONTAL:18,TILED_OFFSET_ZOOM_X2:34,TILED_OFFSET_ZOOM_X3:50,TILED_OFFSET_VERTICAL:19,TILED_OFFSET_VERTICAL_ZOOM_X2:34,TILED_OFFSET_VERTICAL_ZOOM_X3:50,CENTERED:20,CENTERED_ZOOM_X2:36,CENTERED_ZOOM_X3:52};var Channel=(new function(){var _channel=KnuddelsServer.getChannel();var _configuration=_channel.getChannelConfiguration();var _restrictions=_channel.getChannelRestrictions();var _rights=_configuration.getChannelRights();this.getName=function(){return _channel.getChannelName();};this.usersOnline=function(filter){return Channel.getUsers(filter).size();};this.getOwner=function(){var owners=this.getOwners();var owner=undefined;owners.each(function(user,index){if(user.isOnlineInChannel()){owner=user;return;}});return owner;};this.setBackground=function(image,style,user,text){Bot.private(user,'°>{bgimage}'+image+'|'+(style==undefined?Background.SCALED:style)+'<°'+(text==undefined?'Das Hintergrundbild wird geändert':text));};this.getModerators=function(){return _rights.getChannelModerators();};this.getOwners=function(){return _rights.getChannelOwners();};this.getMods=function(){return _rights.getEventModerators();};this.getCMutes=function(){return _restrictions.getColorMutedUsers();};this.getMutes=function(){return _restrictions.getMutedUsers();};this.getCLs=function(){return _restrictions.getLockedUsers();};this.onDev=function(){return KnuddelsServer.getChatServerInfo().isTestSystem();};this.getServer=function(){return KnuddelsServer.getChatServerInfo().getServerId();};this.getUsers=function(filter){filter=filter||{};var types=[UserType.Human];if(filter.bot!=undefined){if(filter.bot){types.push(UserType.AppBot);types.push(UserType.SystemBot);}}
var users=[];var _users=_channel.getOnlineUsers(types);if(!filter.size()){return _users;}
for(var index=0;index<_users.length;index++){if(filter.away!=undefined&&filter.away!=_users[index].isAway()){continue;}
if(filter.cmute!=undefined&&filter.cmute!=_users[index].isColorMuted()){continue;}
if(filter.mute!=undefined&&filter.mute!=_users[index].isMuted()){continue;}
if(filter.cl!=undefined&&filter.cl!=_users[index].isLocked()){continue;}
if(filter.developer!=undefined&&filter.developer!=_users[index].isAppDeveloper()){continue;}
if(filter.owner!=undefined&&filter.owner!=_users[index].isChannelOwner()){continue;}
if(filter.event!=undefined&&filter.event!=_users[index].isEventModerator()){continue;}
if(filter.cm!=undefined&&filter.cm!=_users[index].isChannelModerator()){continue;}
if(filter.status!=undefined&&!filter.status.exists(_users[index].getUserStatus())){continue;}
if(filter.gender!=undefined&&!filter.gender.exists(_users[index].getGender())){}
if(filter.age!=undefined){}
if(filter.nickname!=undefined){}
if(filter.minutes!=undefined){}
if(filter.readme!=undefined){}
users.push(_users[index]);}
return users;};this.toString=function(){return'[KFramework Channel]';};}());
var Status={Newbie:0,Family:1,Stammi:2,Ehrenz:3,Admin:6,Sysadmin:11,Bot:-1};var Users=(new function(){this.getProfilePicture=function(user){var nickname='';if(user.getNick==undefined){user=Users.get(user);}
nickname=user.getNick();return'http://chat.knuddels.de/pics/fotos/knuddels.de?n='+nickname.urlencode();};this.get=function(nickname){if(typeof(nickname)=='number'){if(KnuddelsServer.canAccessUser(nickname)){return KnuddelsServer.getUser(nickname);}}
if(KnuddelsServer.userExists(nickname)){var userId=KnuddelsServer.getUserId(nickname);if(KnuddelsServer.canAccessUser(userId)){return KnuddelsServer.getUser(userId);}}else{return undefined;}
if(typeof(nickname)=='string'){return(new function(){var _nickname=nickname;var _uid=userId;this.virtual=true;this.isVirtual=function(){return true;};this.getPersistence=function(_uid){return(new function VirtualPersistence(uid){_uid=uid;this.addNumber=function(key,value){var userdb=DB.load('_userdb');if(userdb[_uid][key]===undefined){userdb[_uid][key]=0;}
userdb[_uid][key]+=value;DB.save('_userdb',userdb);};this.getString=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getNumber=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.getObject=function(key,defaults){return DB.load('_userdb')[_uid][key]||defaults;};this.deleteNumber=function(key){var userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteObject=function(key){var userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.deleteString=function(key){var userdb=DB.load('_userdb');delete userdb[_uid][key];DB.save('_userdb',userdb);};this.setString=function(key,data){var userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setNumber=function(key,data){var userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};this.setObject=function(key,data){var userdb=DB.load('_userdb');userdb[_uid][key]=data;DB.save('_userdb',userdb);};}());};this.equals=function(user){Logger.warn('using User.equals() on virtual User-Object');};this.getAge=function(){return-1;};this.getGender=function(){return Gender.Unknown;};this.getKnuddelAmount=function(){return new KnuddelAmount(0);};this.getNick=function(){return _nickname;};this.getOnlineMinutes=function(){return-1;};this.getProfilePicture=function(){return'http://chat.knuddels.de/pics/fotos/knuddels.de?n='+_nickname.urlencode();};this.getProfileLink=function(){return'°>_h'+_nickname.escapeKCode()+'|/w "|/serverpp "<°';};this.getReadme=function(){return'';};this.getRegDate=function(){return new Date(0);};this.getID=function(){return _uid;};this.getUserId=function(){return _uid;};this.getUserStatus=function(){return UserStatus.Newbie;};this.getUserType=function(){return UserType.Human;};this.isAppDeveloper=function(){return false;};this.isAppManager=function(){return false;};this.isAway=function(){return false;};this.isChannelModerator=function(){return false;};this.isChannelOwner=function(){return false;};this.isColorMuted=function(){return false;};this.isEventModerator=function(){return false;};this.isLocked=function(){return false;};this.isMuted=function(){return false;};this.isOnline=function(){return false;};this.isOnlineInChannel=function(){return false;};this.getKnuddels=function(){return 0;};this.sendPostMessage=send;this.sendPrivateMessage=send;this.private=send;this.post=send;function send(){Logger.error('Can\t send message to a virtual User-Object!');};_nickname=KnuddelsServer.getNickCorrectCase(_uid);}());}
return nickname;};this.toString=function(value){switch(value){case UserStatus.Newbie:return'Newbie';break;case UserStatus.Family:return'Family';break;case UserStatus.Stammi:return'Stammi';break;case UserStatus.HonoryMember:return'Ehrenz';break;case UserStatus.Admin:return'Admin';break;case UserStatus.Sysadmin:return'Sysadmin';break;case UserStatus.SystemBot:return'Bot';break;default:return'[KFramework User]';break;}
return value+'';};}());
var Payment={TIER_0:0x01,TIER_1:0x02,TIER_2:0x03,TIER_3:0x04,TIER_4:0x05,TIER_5:0x06,TIER_6:0x07,TIER_7:0x08};var PaymentInterval={Daily:0x01,Weekly:0x02,Monthly:0x03};var AppStore=(new function(){var _container=undefined;var _app=undefined;var _developer=KnuddelsServer.getAppDeveloper();var _owner=Channel.getOwner();var _store_data=DB.load('_appstore',{time_payed:undefined,time_first_installed:undefined,is_payed:'F',is_locked:'F',locked_reason:''});var _options={allowed_commands:[],tier:Payment.TIER_0,payment:{knuddel:0,interval:PaymentInterval.Weekly,profit:0}};this.setSettings=function(options){Logger.info('AppStore.setSettings(options) is DEPRECATED');_options=options.compare(_options);return this;};this.app=function(container){Logger.info('AppStore.app(container) is DEPRECATED');_container=new container();_app=new container();if(_app.onAppStart!=undefined&&!AppStore.hasPayed()){_app.onAppStart=function(){try{var test=new Date(_store_data.time_first_installed);}catch(e){_store_data.time_first_installed=undefined;}
if(_store_data.time_first_installed==undefined){_store_data.time_first_installed=new Date().getTime();}
if(AppStore.isLocked()){AppStore.appIsLocked();return;}
if(!AppStore.hasPayed()){AppStore.askForPayment();return;}
_container.onAppStart();};}
if(_app.onPrepareShutdown!=undefined&&!AppStore.hasPayed()){_app.onPrepareShutdown=function(secondsTillShutdown,shutdownType){if(!AppStore.hasPayed()){return;}
_container.onPrepareShutdown(secondsTillShutdown,shutdownType);};}
if(_app.onShutdown!=undefined&&!AppStore.hasPayed()){_app.onShutdown=function(){DB.save('_appstore',_store_data);if(!AppStore.hasPayed()){return;}
_container.onShutdown();};}
if(_app.onUserJoined!=undefined&&!AppStore.hasPayed()){_app.onUserJoined=function(user){if(!AppStore.hasPayed()){return;}
_container.onUserJoined(user);};}
if(_app.onUserLeft!=undefined&&!AppStore.hasPayed()){_app.onUserLeft=function(user){if(!AppStore.hasPayed()){return;}
_container.onUserLeft(user);};}
if(_app.mayJoinChannel!=undefined&&!AppStore.hasPayed()){_app.mayJoinChannel=function(user){if(!AppStore.hasPayed()){return ChannelJoinPermission.accepted();}
return _container.mayJoinChannel(user);};}
if(_app.maySendPublicMessage!=undefined&&!AppStore.hasPayed()){_app.maySendPublicMessage=function(publicMessage){if(!AppStore.hasPayed()){return true;}
return _container.maySendPublicMessage(publicMessage);};}
if(_app.onPrivateMessage!=undefined&&!AppStore.hasPayed()){_app.onPrivateMessage=function(privateMessage){if(!AppStore.hasPayed()){return;}
_container.onPrivateMessage(privateMessage);};}
if(_app.onPublicMessage!=undefined&&!AppStore.hasPayed()){_app.onPublicMessage=function(publicMessage){if(!AppStore.hasPayed()){return;}
_container.onPublicMessage(publicMessage);};}
if(_app.onKnuddelReceived!=undefined&&!AppStore.hasPayed()){_app.onKnuddelReceived=function(sender,receiver,knuddelAmount){if(AppStore.hasPayed()){_container.onKnuddelReceived(sender,receiver,knuddelAmount);return;}
Bot.public("Check Bot Knuddel...");};}
if(_app.onUserDiced!=undefined&&!AppStore.hasPayed()){_app.onUserDiced=function(diceEvent){if(!AppStore.hasPayed()){return;}
_container.onUserDiced(diceEvent);};}
if(_app.chatCommands==undefined){_app.chatCommands={};}
for(var name in _app.chatCommands){_app.chatCommands[name]=function(user,params,command){if(AppStore.isLocked()){Bot.private(user,'Die App ist derzeit °R°_GESPERRT°r°_!');return;}
if(!AppStore.hasPayed()){Bot.private(user,'Die App ist derzeit °R°_DEAKTIVIERT°r°_!');return;}
_container.chatCommands[command](user,params,command);};}
_app.chatCommands['Store:'+KnuddelsServer.getAppName()]=AppStore.handleCommand;return _app;};this.handleCommand=function(user,params,command){if(!user.isAppDeveloper()){Bot.private(user,'Diese Funktion steht dir nicht zur verfügung.');return;}
var command=params;var message='';if(params.indexOf(':')>-1){var split=params.split(':');command=split[0];for(var index in split){if(index>0){message+=split[index];}}}
switch(command){case'!lock':if(_store_data.is_locked=='F'){Bot.private(user,'Die App kann nicht _entsperrt_ werden.');return;}
_store_data.is_locked='F';_store_data.locked_reason='';DB.save('_appstore',_store_data);Bot.private(user,'Die App wurde _entsperrt_!');break;case'lock':if(message.length==0){Bot.private(user,'Du musst eine Sperrgebründung angeben!');return;}
_store_data.is_locked='T';_store_data.locked_reason=message;DB.save('_appstore',_store_data);Bot.private(user,'Die App wurde _°R°GESPERRT°r°_!');break;case'!payed':case'payed':_store_data.is_payed=command.substring(0,1)=='!'?'F':'T';_store_data.time_payed=command.substring(0,1)=='!'?undefined:new Date().getTime();DB.save('_appstore',_store_data);Bot.private(user,'Die App wurde _°R°'+(command.substring(0,1)=='!'?'STORNIERT':'BEZAHLT')+'°r°_!');break;default:var text=new KCode();text.append('_Available Commands:_');text.newLine();text.append('°>/Store:'+KnuddelsServer.getAppName()+' lock:[Message]|/tf-overridesb /Store:'+KnuddelsServer.getAppName()+' lock:[Message]<°');text.newLine();text.append('°>/Store:'+KnuddelsServer.getAppName()+' !lock|/Store:'+KnuddelsServer.getAppName()+' !lock<°');text.newLine();text.append('°>/Store:'+KnuddelsServer.getAppName()+' payed|/Store:'+KnuddelsServer.getAppName()+' payed<°');text.newLine();text.append('°>/Store:'+KnuddelsServer.getAppName()+' !payed|/Store:'+KnuddelsServer.getAppName()+' !payed<°');text.newLine();text.newLine();text.append('_Informations:_');text.newLine();text.append(JSON.stringify(_store_data).escapeKCode());Bot.private(user,text);break;}};this.isLocked=function(){Logger.info('AppStore.isLocked() is DEPRECATED');if(_options.tier==Payment.TIER_0&&_developer.getUserId()!=_owner.getUserId()){if(_store_data.is_payed=='T'){return false;}
return true;}
if(_store_data.is_locked=='T'){return true;}
return false;};this.hasPayed=function(){Logger.info('AppStore.hasPayed() is DEPRECATED');if(_options.tier==Payment.TIER_0&&_developer.getUserId()==_owner.getUserId()){return true;}
return _store_data.is_payed=='T';};this.askForPayment=function(){var text=new KCode();var knuddel_button=new KButton(_options.knuddel+' Knuddel bezahlen*','/knuddel '+Bot.getNick()+':'+_options.knuddel);knuddel_button.setIcon('sm_classic_yellow.gif');text.append('Hallo _');text.append(_owner.getProfileLink());text.append('_!');text.newLine();text.append('Du möchtest die App _');text.append(KnuddelsServer.getAppName());text.append('_ von ');text.append(_developer.getProfileLink());text.append(' installieren.');text.newLine();text.append('Der App-Entwickler möchte für die Nutzung dieser App ');text.append(new KImage('sm_classic_yellow.gif'));text.append('_ ');text.append(_options.knuddel);text.append(' Knuddel_ haben:');text.newLine();text.newLine();text.append(knuddel_button);text.newLine();text.append('°12°');text.append('"');text.append('* Die anfallende Gebühr wird auf deinem AppBot gesendet und wird dann an den App-Entwickler weitergereicht.');text.newLine();text.append('  Nach erfolgreicher Transaktion wird die App freigeschaltet und du kannst diese dann im vollen Umfang nutzen!');text.append('°r°');Bot.private(_owner,text);};this.appIsLocked=function(){var text=new KCode();text.append('Diese App ist °R°_GESPERRT_°r°!');if(_developer.getUserId()!=_owner.getUserId()){text.newLine();text.append('Du darfst diese App nicht installieren da diese ausschließlich für den App-Entwickler _');text.append(_developer.getProfileLink());text.append('_ vorbehalten ist.');}else if(_store_data.locked_reason.length>0){text.newLine();text.append('Grund:');text.newLine();text.addDots();text.append(_store_data.locked_reason);text.newLine();text.append('Bitte wende dich an den App-Entwickler _');text.append(_developer.getProfileLink());text.append('_ um das Problem zu lösen.');}else{text.newLine();text.append('Bitte wende dich an den App-Entwickler _');text.append(_developer.getProfileLink());text.append('_ um das Problem zu lösen.');}
Bot.private(_owner,text);};this.toString=function(){return'[KFramework AppStore]';};});
var VERSION='1.0.6';var KFramework=(new function(){this.load=['tools/Functions','tools/Number','tools/String','tools/Array','tools/Object','tools/User','tools/Dice','tools/StringBuffer','core/Hash','core/Hooks','core/Database','core/Logger','core/Cronjob','core/Bot','core/KCode','core/KBank','core/Channel','core/User','core/AppStore'];for(var entry in this.load){}
this.startUp=function(){KBank.dataMigration();};this.store=function(){Cron.saveData();};this.shutDown=function(){Cron.onShutdown();};this.toString=function(){return'[KFramework Core]';};}());
function KButton(text,command){var _text='';var _id=-1;var _command='';var _properties={};function KButton(text,command){if(text===undefined){return;}
_text=text;if(command===undefined){return;}
_command=command;return this;};this.setID=function(id){_id=id;return this;};this.getID=function(){return _id;};this.getCommand=function(){return _command;};this.setCommand=function(command){_command=command;return this;};this.getText=function(){return _text;};this.setText=function(text){_text=text;return this;};this.getProperties=function(){return _properties;};this.setProperties=function(properties){_properties=properties;return this;};this.setIcon=function(icon){if(icon.startsWith('https://')||icon.startsWith('http://')){icon='../'+icon;}
_properties.icon=icon;return this;};this.removeIcon=function(){delete _properties.icon;return this;};this.setColor=function(color){_properties.color=color;return this;};this.removeColor=function(){delete _properties.color;return this;};this.getHeight=function(){return _properties.height;};this.setHeight=function(height){_properties.height=height;return this;};this.removeHeight=function(){delete _properties.height;return this;};this.getWidth=function(){return _properties.width;};this.setWidth=function(width){_properties.width=width;return this;};this.removeWidth=function(){delete _properties.width;return this;};this.setSize=function(width,height){this.setWidth(width);this.setHeight(height);return this;};this.removeSize=function(){this.removeWidth();this.removeHeight();return this;};this.getX=function(){return _properties.mx;};this.setX=function(x){_properties.mx=x;return this;};this.getY=function(){return _properties.my;return this;};this.setY=function(y){_properties.my=y;return this;};this.setPosition=function(x,y){this.setX(x);this.setY(y);return this;};this.useTextborder=function(bool){if(bool){_properties.textborder='1';}else{delete _properties.textborder;}
return this;};this.setEnabled=function(bool){if(bool==false){_properties.enabled='0';}else{delete _properties.enabled;}
return this;};this.toString=function(){var buffer=new StringBuffer('°>{button}');if(_text.length>0){buffer.append(_text+'|'+(_id>0?_id:'')+'|');}
if(_command.length>0){buffer.append('call|'+_command.replace(/\|/g,'\\\\\\\\\\|'));}
_properties.each(function(value,name){buffer.append('|'+name+'|'+value);});buffer.append('<°');return buffer.toString();};KButton(text,command);}
var KCODE_TOOLTIPS_INSTANCES=0;function KTooltip(content){var _content=new KCode();var _instance=0;var _hover_disabled=false;var _width=100;var _height=100;function KTooltip(content){if(content!=undefined){_content.append(content);}
_instance=KCODE_TOOLTIPS_INSTANCES++;};this.setSize=function(width,height){_width=width;_height=height;return this;};this.setWidth=function(width){_width=width;return this;};this.setHeight=function(height){_height=height;return this;};this.append=function(content){_content.append(content);return this;};this.newLine=function(){_content.newLine();return this;};this.disableHover=function(state){_hover_disabled=state;};this.getCommand=function(text,command){if(!(text instanceof KLink)){text=new KLink(text);if(_hover_disabled){text.setCommand((command==undefined?'':'/doubleaction '+command+'|')+'/openpulldown id_'+_instance+'.w_'+_width+'.h_'+_height);}else{text.setCommand((command==undefined?'/void':command)+'{{onEnter=/openpulldown id_'+_instance+'.w_'+_width+'.h_'+_height+'}}{{onExit=/closepulldown id_'+_instance+'}}');}}
return text;};this.toString=function(){var output=new KCode();output.append('°>{definetext|').append(_instance).append('}<°').append(_content).append('°>{definetext|').append(_instance).append('}<°');return output;};KTooltip(content);};
function KLink(text,command_left,command_right){var _text='';var _command_left=undefined;var _command_right=undefined;var _hover=true;var _hover_image=undefined;function KLink(text,command_left,command_right){_text=text||'';_command_left=command_left;_command_right=command_right;}
function prepareLink(string){return string.replace(/(<|>|\||°)/g,'\\$1');}
this.getText=function(){return _text;};this.setCommand=function(command_left,command_right){_command_left=command_left;_command_right=command_right;return this;};this.enableHover=function(state){_hover=state;return this;};this.setHoverImage=function(image){if(_text instanceof KImage){_hover_image=image;}else{Logger.warn('You can only use KImage.setHoverImage(image) when you bind a KImage!');}
return this;};this.toString=function(){var buffer=new StringBuffer('°>');if(_text instanceof KImage){if(_hover==false){_text.noPush(true);_hover_image.noPush(true);}
buffer.append(_text.toString(true));if(_hover_image!=undefined){buffer.append('|'+_hover_image.toString(true));}
buffer.append('<>--<>');}else{if(_hover==false){buffer.append('_h');}
buffer.append(prepareLink(_text));}
if(_command_left!=undefined){buffer.append('|'+_command_left.replace(/\|/g,'\\\\\\\\\\|'));}
if(_command_right!=undefined){buffer.append('|'+_command_right.replace(/\|/g,'\\\\\\\\\\|'));}
buffer.append('<°');return buffer.toString();};KLink(text,command_left,command_right);};
function KCountdown(){var _properties={};this.setTime=function(time){_properties.time=time;return this;};this.setFormat=function(format){_properties.format=format;return this;};this.setText=function(text){_properties.timeUpText=text;return this;};this.toString=function(){var buffer=new StringBuffer('°>{countdown}');var index=0;var length=_properties.size();_properties.each(function(value,name){buffer.append(name+'='+value);if(index+1<length){buffer.append('|');}
index++;});buffer.append('<°');return buffer.toString();};}
var FontStyle={PLAIN:0x00,BOLD:0x01,ITALIC:0x02};function KFont(name,style,size){var _name='Arial';var _size=14;var _style=FontStyle.PLAIN;var _available=['RobotoBold','RobotoLight','FinelinerScript','Arial','Impact'];function KFont(name,style,size){_name=name;_size=size;_style=style;}
this.toString=function(){var output='';if(_style&FontStyle.BOLD){output+='_';}
if(_style&FontStyle.ITALIC){output+='"';}
output+='°';if(_available.indexOf(_name)>-1){output+='>{font}'+_name+'<';}else{Logger.info('Font '+_name+' does\'nt exists!');}
output+=_size+'°';return output;};KFont(name,style,size);}
var KImage=KImage||(function(image){this._path='';this._name='';this._extension='';this._properties={};if(image.substring(0,7)=='http://'||image.substring(0,8)=='https://'){var split=image.split('/');var length=split.length;image=split[length-1];for(var index=0;index<length-1;++index){this._path+=split[index];this._path+='/';}}
if(image.indexOf('..')>-1){var properties=image.split('..');var instance=this;var split=image.split('.');var length=split.length;image=properties[0];image+='.';image+=split[length-1];split.each(function(name,index){if(name.length==0||index==0||index==length-1){return;}
if(name.search(/[^a-zA-Z0-9_]+/gi)!=-1){return;}
if(name.indexOf('_')!=-1){var split=name.split('_');instance._properties[split[0]]=split[1];}else{instance._properties[name]=null;}});}
var split=image.split('.');if(['png','jpg','jpeg','bmp','gif'].indexOf(split[1].toLowerCase())!=-1){this._name=split[0];this._extension=split[1];}else{this._name=image;}
this._name=this._name.replace(/&\.(png|jpeg|gif|jpg|bmp)/gi,'');var first=this._name.substring(0,1);if(first=='/'||first=='~'){this._name=this._name.substring(1);this._path=KnuddelsServer.getFullImagePath('');}
this.toString=function(only_path){only_path=only_path||false;var output=(only_path==true?'':'°>')+this._path+this._name;var buffer=new StringBuffer();if(this._properties.size()>0){buffer.append('..');this._properties.each(function(value,name){if(value==undefined){return;}
buffer.append('.'+name+(value==null?'':'_'+value));});}
return output+(this._extension.length==0?'&'+buffer.toString()+'.png':buffer.toString()+'.'+this._extension)+(only_path==true?'':'<°');};return this;});KImage.prototype=KImage.prototype||{};if(!KImage.prototype.addCustom){Object.defineProperty(KImage.prototype,'addCustom',{enumerable:false,configurable:false,writable:false,value:function(name,value){this._properties[name]=value;return this;}});}
if(!KImage.prototype.alwaysCopy){Object.defineProperty(KImage.prototype,'alwaysCopy',{enumerable:false,configurable:false,writable:false,value:function(state){this.addCustom('alwayscopy',(state?null:undefined));return this;}});}
if(!KImage.prototype.noPush){Object.defineProperty(KImage.prototype,'noPush',{enumerable:false,configurable:false,writable:false,value:function(state){this.addCustom('nopush',(state?null:undefined));return this;}});}
if(!KImage.prototype.setContainerSize){Object.defineProperty(KImage.prototype,'setContainerSize',{enumerable:false,configurable:false,writable:false,value:function(width,height){this.addCustom('w',width);this.addCustom('h',height);return this;}});}
if(!KImage.prototype.setSize){Object.defineProperty(KImage.prototype,'setSize',{enumerable:false,configurable:false,writable:false,value:function(width,height){this.addCustom('mw',width);this.addCustom('mh',height);return this;}});}
if(!KImage.prototype.setPosition){Object.defineProperty(KImage.prototype,'setPosition',{enumerable:false,configurable:false,writable:false,value:function(x,y){this.addCustom('mx',x);this.addCustom('my',y);return this;}});}
if(!KImage.prototype.setX){Object.defineProperty(KImage.prototype,'setX',{enumerable:false,configurable:false,writable:false,value:function(x){this.addCustom('mx',x);return this;}});}
if(!KImage.prototype.setY){Object.defineProperty(KImage.prototype,'setY',{enumerable:false,configurable:false,writable:false,value:function(y){this.addCustom('my',y);return this;}});}
if(!KImage.prototype.setLabel){Object.defineProperty(KImage.prototype,'setLabel',{enumerable:false,configurable:false,writable:false,value:function(text){this.addCustom('label',text);return this;}});}
if(!KImage.prototype.setLabelPosition){Object.defineProperty(KImage.prototype,'setLabelPosition',{enumerable:false,configurable:false,writable:false,value:function(x,y){this.addCustom('lmx',x);this.addCustom('lmy',y);return this;}});}
if(!KImage.prototype.setLabelColor){Object.defineProperty(KImage.prototype,'setLabelColor',{enumerable:false,configurable:false,writable:false,value:function(color){this.addCustom('labelcolor',color);return this;}});}
if(!KImage.prototype.setLabelSize){Object.defineProperty(KImage.prototype,'setLabelSize',{enumerable:false,configurable:false,writable:false,value:function(size){this.addCustom('labelfontsize',size);return this;}});}
if(!KImage.prototype.enableLabelBorder){Object.defineProperty(KImage.prototype,'enableLabelBorder',{enumerable:false,configurable:false,writable:false,value:function(bool){this.addCustom('labelborder',(bool?'1':'0'));return this;}});}
if(!KImage.prototype.setBorder){Object.defineProperty(KImage.prototype,'setBorder',{enumerable:false,configurable:false,writable:false,value:function(size){this.addCustom('border',size);return this;}});}
if(!KImage.prototype.setQuadcut){Object.defineProperty(KImage.prototype,'setQuadcut',{enumerable:false,configurable:false,writable:false,value:function(size){this.addCustom('quadcut',size);return this;}});}
if(!KImage.prototype.setShadow){Object.defineProperty(KImage.prototype,'setShadow',{enumerable:false,configurable:false,writable:false,value:function(position){this.addCustom('shadow',position);return this;}});}
if(!KImage.prototype.setMirror){Object.defineProperty(KImage.prototype,'setMirror',{enumerable:false,configurable:false,writable:false,value:function(state){this.addCustom('mirror',(state?null:undefined));return this;}});}
if(!KImage.prototype.setGreyscale){Object.defineProperty(KImage.prototype,'setGreyscale',{enumerable:false,configurable:false,writable:false,value:function(state){this.addCustom('gray',(state?null:undefined));return this;}});}
if(!KImage.prototype.setTransparency){Object.defineProperty(KImage.prototype,'setTransparency',{enumerable:false,configurable:false,writable:false,value:function(value){this.addCustom('opacity',value);return this;}});}
if(!KImage.prototype.setMouseSize){Object.defineProperty(KImage.prototype,'setMouseSize',{enumerable:false,configurable:false,writable:false,value:function(width,height){this.addCustom('mousew',width);this.addCustom('mouseh',height);return this;}});}
if(!KImage.prototype.setMousePosition){Object.defineProperty(KImage.prototype,'setMousePosition',{enumerable:false,configurable:false,writable:false,value:function(x,y){this.addCustom('mousex',x);this.addCustom('mousey',y);return this;}});}
var Color={CHANNEL_RED:new ColorInstance('RR',[-255,0,0]),CHANNEL_BLUE:new ColorInstance('BB',[0,0,-255]),WHITE:new ColorInstance('W',[255,255,255]),BLACK:new ColorInstance('K',[0,0,0]),GRAY:new ColorInstance('A',[128,128,128]),LIGHT_GREY:new ColorInstance('L',[192,192,192]),DARK_GREY:new ColorInstance('D',[64,64,64]),RED:new ColorInstance('R',[255,0,0]),BLUE:new ColorInstance('B',[0,0,255]),GREEN:new ColorInstance('G',[0,255,0]),DARK_GREEN:new ColorInstance('E',[0,172,0]),YELLOW:new ColorInstance('Y',[255,255,0]),CYAN:new ColorInstance('C',[0,255,255]),MAGENTA:new ColorInstance('M',[255,0,255]),PINK:new ColorInstance('P',[255,175,175]),ORANGE:new ColorInstance('O',[255,200,0]),BROWN:new ColorInstance('N',[150,74,0]),decode:function(hex){var color=new KColor();color.decode(hex);return color;}};function KColor(red,green,blue){var _red=-1;var _green=-1;var _blue=-1;function KColor(instance,red,green,blue){if(red!=undefined&&green==undefined&&blue==undefined){if(isHex(red)){instance.decode(red);return;}else if(isRGB(red)){var split=red.split(',');_red=parseInt(split[0]);_green=parseInt(split[1]);_blue=parseInt(split[2]);return;}}
_red=red;_green=green;_blue=blue;};function isHex(input){return(input.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i));};function isRGB(input){return(input.match(/^([\d]{1,3}),([\d]{1,3}),([\d]{1,3})$/i));};function isConstant(){for(var name in Color){if(name=='decode'){continue;}
var _color_instance=Color[name];if(_color_instance!=undefined){if(_color_instance.getRed()==_red&&_color_instance.getGreen()==_green&&_color_instance.getBlue()==_blue){return true;}}}
return false;};function getConstant(){for(var name in Color){if(name=='decode'){continue;}
var _color_instance=Color[name];if(_color_instance.getRed()==_red&&_color_instance.getGreen()==_green&&_color_instance.getBlue()==_blue){return _color_instance;}}
return'';};this.getRGB=function(){var buffer=new StringBuffer();buffer.append(_red).append(',').append(_green).append(',').append(_blue);return buffer.toString();};this.decode=function(hex){var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);_red=parseInt(result[1],16);_green=parseInt(result[2],16);_blue=parseInt(result[3],16);};this.toString=function(){var output=new KCode();if(isConstant()){output.append(getConstant());}else{output.append('°[').append(_red).append(',').append(_green).append(',').append(_blue).append(']°');}
return output;};KColor(this,red,green,blue);};function ColorInstance(key,rgb){this.getColorKey=function(){return key;};this.getRGB=function(){return rgb;};this.getRed=function(){return rgb[0];};this.getGreen=function(){return rgb[1];};this.getBlue=function(){return rgb[2];};this.toString=function(){var output=new KCode();output.append('°').append(key).append('°');return output;};}
function KTable(){var _rows=[];this.add=function(element){_rows.push(element);return this;};this.toString=function(){var output=new KCode();output.append('°>{table');if(_rows.length>0){output.append('|');}
_rows.each(function(row,row_index){row.getCells().each(function(cell,cell_index){output.append('|').append(cell.getSize());});return false;});output.append('}<°');_rows.each(function(row,index){output.append(row.toString(index==0));});output.append('°>{endtable}<°');return output;};}
function KRow(){var _cells=[];function KRow(){_cells=[];}
this.add=function(cell){_cells.push(cell);return this;};this.getCells=function(){return _cells;};this.toString=function(display){display=display||false;var output=new KCode();if(!display){output.append('°>{tr}<°');}
_cells.each(function(cell){output.append(cell);});return output;};KRow();}
function KCell(size,content){var _size=0;var _content='';function KCell(size,content){_size=size||0;_content=content||'';}
this.getSize=function(){return _size;};this.toString=function(){var output=new KCode();output.append('°>{tc}<°').append(_content);return output;};KCell(size,content);}
var KCODE_GROUPS_INSTANCES=0;function KGroup(){var _groups=[undefined];var _show=0;var _layout_box=false;this.add=function(content){_groups.push(content);return this;};this.remove=function(index){delete _groups[index];return this;};this.update=function(index,content){_groups[index]=content;return this;};this.show=function(index){_show=index;return this;};this.enableBoxLayout=function(state){_layout_box=state;return this;};this.getNavigation=function(titles){titles=(titles==undefined?[]:titles);var buffer=new StringBuffer();var size=_groups.size();buffer.append('°12BB+0000°_°>LEFT<°');_groups.each(function(content,index){if(content==undefined){return;}
var entry=parseInt(index)+1;var title=(titles[entry-2]==undefined?'Tab '+entry:titles[entry-2]);if(_layout_box){var left='layout/tab_i_l...w_8.mx_-1.png';var middle='layout/tab_i_c...label_'+title+'.mw_'+(title.length*1.12)+'.png';var right='layout/tab_i_r.png';buffer.append('°>'+left+'<°').append('°>'+middle+'|'+middle+'<>--<>|/tp-showgrp '+entry+'<°');buffer.append('°>'+right+'<°');}else{buffer.append('°>'+title+'|/tp-showgrp '+entry+'<°');if(entry<size){buffer.append(' - ');}}});buffer.append('°>LEFT<°_°r##°');return buffer.toString();};this.getTabCommand=function(index){return'/tp-showgrp '+index;};this.switchTab=function(index){return'°>{setdisplaygroup}'+index+'<°';};this.toString=function(){var buffer=new StringBuffer();buffer.append('°>{addDisplayGroup}').append(_show).append('<°');_groups.each(function(content,index){if(content==undefined){return;}
buffer.append('°>{displayGroup}').append(parseInt(index)).append('<°').append(content).append('°>{displayGroupEnd}<°');});return buffer.toString();};};